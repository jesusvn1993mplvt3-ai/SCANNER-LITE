<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balta Scan - Urban Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Black+Ops+One&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">

    <style>
        body { 
            background-color: #1a1a1a;
            background-image: 
                linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)),
                url('https://www.transparenttextures.com/patterns/asfalt-dark.png');
            font-family: 'Roboto Mono', monospace;
            color: #fff;
            overflow: hidden;
        }
        .font-graffiti { font-family: 'Permanent+Marker', cursive; }
        .font-stencil { font-family: 'Black Ops One', system-ui; }
        
        .scan-overlay {
            position: absolute;
            inset: 0;
            border: 2px solid #3b82f6;
            box-shadow: inset 0 0 100px rgba(59, 130, 246, 0.2);
            pointer-events: none;
        }
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #3b82f6;
            box-shadow: 0 0 15px #3b82f6;
            animation: scanLine 2s linear infinite;
        }
        #reader { border: none !important; width: 100% !important; }
        #reader video { object-fit: cover !important; border-radius: 4px; }
        #reader__dashboard { display: none !important; }

        .tag-card {
            background: #222;
            border-left: 8px solid #3b82f6;
            position: relative;
            overflow: hidden;
        }
        .tag-card::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.02) 10px, rgba(255,255,255,0.02) 20px);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = { apiKey: "AIzaSyCngQL1pdqghv2vbjkPycT1Xf0C46f7jYs", authDomain: "cirineo-cec21.firebaseapp.com", projectId: "cirineo-cec21", storageBucket: "cirineo-cec21.firebasestorage.app", messagingSenderId: "620210618284", appId: "1:620210618284:web:482bab9bf74650fff18409" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (lucide.icons[name]) {
                    ref.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size });
                }
            }, [name, size]);
            return <span ref={ref} className={`inline-flex items-center justify-center ${className}`} />;
        };

        const App = () => {
            const [selectedMachine, setSelectedMachine] = useState(null);
            const [pending, setPending] = useState(null);
            const [scannerActive, setScannerActive] = useState(false);
            const [allOrders, setAllOrders] = useState([]);
            const lastScan = useRef(null);
            const html5QrCode = useRef(null);

            useEffect(() => {
                const unsub = db.collection('orders').onSnapshot(snap => {
                    setAllOrders(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsub();
            }, []);

            const initScanner = () => {
                if (html5QrCode.current) return;
                const scanner = new Html5Qrcode("reader");
                html5QrCode.current = scanner;
                
                const config = { fps: 15, qrbox: { width: 250, height: 250 } };
                
                scanner.start({ facingMode: "environment" }, config, (text) => {
                    if (text !== lastScan.current) handleScan(text.trim().toUpperCase());
                }).catch(err => console.error("Error cámara:", err));
                
                setScannerActive(true);
            };

            const handleScan = async (code) => {
                lastScan.current = code;
                new Audio('https://www.soundjay.com/button/beep-07.mp3').play().catch(() => {});

                if (!selectedMachine) {
                    alert("⚠️ SELECCIONA MÁQUINA");
                    lastScan.current = null;
                    return;
                }

                // LÓGICA DE KIT (AGRUPADOR)
                if (code.startsWith('K')) {
                    const doc = await db.collection('kits_datos').doc(code).get();
                    if (doc.exists) {
                        const kit = doc.data();
                        setPending({
                            type: 'kit',
                            id: code,
                            data: kit,
                            piezas: kit.piezas.map(p => ({ ...p, modelo: kit.modelo, partida: kit.partida }))
                        });
                    } else alert("❌ KIT NO ENCONTRADO EN BD");
                } 
                // LÓGICA PAPELETA INDIVIDUAL
                else {
                    let found = null;
                    allOrders.forEach(order => {
                        const p = order.progreso?.find(i => i.codigoUnico === code);
                        if (p) found = { ...p, orderId: order.id, modelo: order.codigo, partida: order.partida };
                    });
                    if (found) setPending({ type: 'single', id: code, data: found, piezas: [found] });
                    else alert("❌ CÓDIGO INVÁLIDO");
                }
            };

            const confirmRegister = async () => {
                if (!pending || !selectedMachine) return;
                const batch = db.batch();
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();

                try {
                    pending.piezas.forEach(p => {
                        const ref = db.collection('production_scans').doc();
                        batch.set(ref, {
                            codigoUnico: p.codigoUnico || pending.id,
                            pedido: p.modelo || p.pedido || "",
                            estilo: p.modelo || "",
                            partida: p.partida || "",
                            paqueteNum: p.paqueteNum || 0,
                            piezaNombre: p.piezaNombre || "",
                            cantidad: p.cantidad || 0,
                            machineId: selectedMachine,
                            machineName: selectedMachine,
                            scannedAt: timestamp,
                            status: 'PENDIENTE'
                        });
                    });

                    await batch.commit();
                    setPending(null);
                    lastScan.current = null;
                    alert("TAGS REGISTRADOS EN M" + selectedMachine);
                } catch (e) { alert("ERROR AL GUARDAR"); }
            };

            return (
                <div className="flex flex-col h-screen max-w-md mx-auto relative overflow-hidden">
                    {/* Header Estética Original */}
                    <div className="p-4 flex justify-between items-center border-b border-zinc-800 bg-black/40 backdrop-blur-md z-10">
                        <div className="flex items-center gap-2">
                            <div className="w-3 h-3 bg-blue-500 rounded-full animate-pulse shadow-[0_0_10px_#3b82f6]"></div>
                            <span className="font-stencil text-xs tracking-tighter text-zinc-400">BALTA_SYSTEM_V4.0</span>
                        </div>
                        <div className="font-graffiti text-2xl text-blue-500 -rotate-2">Cirineo</div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 flex flex-col gap-4">
                        {/* Selector de Máquina Estética Urban */}
                        <div className="grid grid-cols-4 gap-2">
                            {[1,2,3,4,5,6,7,8,9,10,11,12].map(m => (
                                <button key={m} onClick={() => setSelectedMachine(m)}
                                    className={`py-3 font-stencil text-sm rounded-sm border transition-all ${selectedMachine === m ? 'bg-blue-600 border-white text-white shadow-[0_0_15px_rgba(59,130,246,0.6)]' : 'bg-zinc-900 border-zinc-800 text-zinc-500'}`}>
                                    M{m}
                                </button>
                            ))}
                        </div>

                        {/* Scanner Area */}
                        {!scannerActive ? (
                            <button onClick={initScanner} className="flex-1 min-h-[300px] border-2 border-dashed border-zinc-700 rounded-sm flex flex-col items-center justify-center gap-4 bg-zinc-900/30 group">
                                <Icon name="camera" size={48} className="text-zinc-700 group-hover:text-blue-500 transition-colors" />
                                <span className="font-stencil text-zinc-600 group-hover:text-zinc-400 uppercase tracking-widest text-xs">Iniciar Protocolo de Escaneo</span>
                            </button>
                        ) : (
                            <div className={`relative rounded-sm overflow-hidden border-2 border-zinc-800 transition-all duration-500 ${pending ? 'h-32' : 'h-80'}`}>
                                <div id="reader"></div>
                                <div className="scan-overlay"><div className="scan-line"></div></div>
                            </div>
                        )}

                        {/* Visualización de Etiquetas (Pending) */}
                        {pending && (
                            <div className="flex-1 flex flex-col animate-in fade-in slide-in-from-bottom-4 duration-500">
                                <div className="tag-card p-4 rounded-sm flex-1 flex flex-col">
                                    <div className="flex justify-between items-start mb-4">
                                        <div>
                                            <h2 className="font-stencil text-2xl text-white leading-none">{pending.data.modelo || pending.data.codigo}</h2>
                                            <p className="text-[10px] text-blue-400 font-bold uppercase tracking-widest mt-1">KIT_ID: {pending.id}</p>
                                        </div>
                                        <div className="text-right">
                                            <span className="block font-stencil text-3xl text-blue-500 leading-none">M{selectedMachine}</span>
                                            <span className="text-[8px] text-zinc-500 uppercase font-black">Asignación</span>
                                        </div>
                                    </div>

                                    <div className="flex-1 overflow-y-auto pr-2 space-y-2 max-h-48 custom-scroll">
                                        {pending.piezas.map((p, i) => (
                                            <div key={i} className="bg-black/40 p-2 border border-zinc-800 flex justify-between items-center">
                                                <span className="text-[10px] font-bold uppercase text-zinc-300">{p.piezaNombre?.split(' ')[0]} <span className="text-zinc-600">#{p.paqueteNum}</span></span>
                                                <span className="font-stencil text-blue-400">{p.cantidad}</span>
                                            </div>
                                        ))}
                                    </div>

                                    <div className="mt-4 flex gap-2">
                                        <button onClick={() => {setPending(null); lastScan.current = null;}} className="flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 font-black py-3 rounded-sm text-xs uppercase">
                                            Abortar
                                        </button>
                                        <button onClick={confirmRegister} className="flex-[2] bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-500 hover:to-blue-700 text-white font-black py-3 rounded-sm border-b-4 border-blue-900 active:border-b-0 active:mt-1 shadow-[0_0_15px_rgba(59,130,246,0.4)] flex items-center justify-center gap-2">
                                            <Icon name="spray-can" size={18} /> TAGGEAR (CONFIRMAR)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Footer */}
                    <div className="p-4 text-center">
                        <div className="text-[10px] text-zinc-600 font-stencil tracking-widest">
                            SISTEMA CIRINEO // URBN OPS
                        </div>
                    </div>
                    
                    <style>{`
                        @keyframes scanLine {
                            0% { top: 0%; opacity: 0; }
                            10% { opacity: 1; }
                            90% { opacity: 1; }
                            100% { top: 100%; opacity: 0; }
                        }
                    `}</style>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>