<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Lite G6 - Cirineo</title>
    <meta name="description" content="Escáner ligero de producción optimizado para dispositivos Moto G6 Play.">

    <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/d/d1/Barcode_Scanner_icon.png">
    <link rel="apple-touch-icon" href="https://upload.wikimedia.org/wikipedia/commons/d/d1/Barcode_Scanner_icon.png">
    
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://cirineo-cec21.web.app/"> <meta property="og:title" content="Escáner de Producción Lite">
    <meta property="og:description" content="Herramienta ligera para escaneo de papeletas en planta. Optimizado para bajo consumo.">
    <meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/d/d1/Barcode_Scanner_icon.png">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:image" content="https://upload.wikimedia.org/wikipedia/commons/d/d1/Barcode_Scanner_icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #1e293b; color: #f1f5f9; font-family: system-ui, -apple-system, sans-serif; }
        .camera-container { width: 100%; aspect-ratio: 1; max-height: 50vh; overflow: hidden; position: relative; }
        #reader { width: 100%; height: 100%; }
        #reader a { display: none !important; }
        /* Estilo para el área de enfoque del QR */
        .scan-region {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 70%;
            border: 2px solid rgba(255, 255, 255, 0.5);
            pointer-events: none;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            box-sizing: border-box;
            opacity: 0.9;
        }
        .scan-region::before, .scan-region::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-color: #facc15;
            border-style: solid;
        }
        .scan-region::before { top: -2px; left: -2px; border-width: 2px 0 0 2px; }
        .scan-region::after { top: -2px; right: -2px; border-width: 2px 2px 0 0; }
        .scan-region-bottom-left::before { bottom: -2px; left: -2px; border-width: 0 0 2px 2px; }
        .scan-region-bottom-right::after { bottom: -2px; right: -2px; border-width: 0 2px 2px 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue; 

        const Icon = ({ name, size = 18, className }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current && lucide.icons[name]) {
                    containerRef.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size, class: className });
                }
            }, [name, size, className]);
            return <div ref={containerRef} className="inline-block" style={{ width: size, height: size }}></div>;
        };

        const ScannerG6 = () => {
            const [scans, setScans] = useState([]); // Array de códigos únicos escaneados
            const [isSaving, setIsSaving] = useState(false);
            const [status, setStatus] = useState({ type: 'info', message: 'Iniciando cámara...' });
            const [allOrders, setAllOrders] = useState([]); // Para buscar el código único

            const html5QrcodeScannerRef = useRef(null);
            const SCAN_INTERVAL_MS = 1500; // Pausa después de cada escaneo

            // 1. Cargar todas las órdenes activas al iniciar
            useEffect(() => {
                const unsubscribe = db.collection('orders').where('status', '!=', 'ARCHIVADO').onSnapshot(snapshot => {
                    const fetchedOrders = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    setAllOrders(fetchedOrders);
                }, (error) => {
                    setStatus({ type: 'error', message: 'Error cargando órdenes.' });
                });
                return () => unsubscribe();
            }, []);

            // 2. Inicializar y controlar el scanner
            useEffect(() => {
                if (html5QrcodeScannerRef.current) {
                    html5QrcodeScannerRef.current.clear().catch(err => console.error("Error clearing scanner on remount", err));
                }
                
                const onScanSuccess = (decodedText) => {
                    handleScanResult(decodedText);
                    if (html5QrcodeScannerRef.current) {
                        html5QrcodeScannerRef.current.pause(); 
                        setTimeout(() => {
                            if (html5QrcodeScannerRef.current) html5QrcodeScannerRef.current.resume();
                        }, SCAN_INTERVAL_MS); 
                    }
                };

                // Configuración optimizada para Lite G6 (o baja potencia)
                const html5QrcodeScanner = new Html5QrcodeScanner(
                    "reader", 
                    { 
                        fps: 10, // Bajamos FPS
                        qrbox: { width: 220, height: 180 }, // Reducimos el área de detección
                        aspectRatio: 1.0, 
                        videoConstraints: { facingMode: "environment" } 
                    },
                    false 
                );

                html5QrcodeScanner.render(onScanSuccess, (errorMessage) => {
                    // console.log("Camera error or scan fail: ", errorMessage);
                    if (status.message === 'Iniciando cámara...') {
                        setStatus({ type: 'info', message: 'Cámara lista. Escanea una papeleta.' });
                    }
                });

                html5QrcodeScannerRef.current = html5QrcodeScanner;

                return () => {
                    if (html5QrcodeScannerRef.current) {
                        html5QrcodeScannerRef.current.clear().catch(err => console.error("Error clearing scanner on unmount", err));
                    }
                };
            }, []);

            // 3. Manejo del escaneo: Busca el código único
            const handleScanResult = (rawCode) => {
                if (!rawCode) return;
                const scannedCode = rawCode.trim();

                if (scans.includes(scannedCode)) {
                    setStatus({ type: 'warning', message: `Código ${scannedCode} ya en la lista.` });
                    return;
                }
                
                // BUSQUEDA INTELIGENTE: Verificar que el código exista en alguna orden activa
                let foundPackage = null;
                for (const order of allOrders) {
                    if (order.progreso) {
                        const pkg = order.progreso.find(p => p.codigoUnico === scannedCode);
                        if (pkg) {
                            // Almacenamos el código, la orden ID y el índice para la confirmación
                            foundPackage = { 
                                code: scannedCode, 
                                orderId: order.id, 
                                modelo: order.codigo, 
                                partida: order.partida,
                                piezaNombre: pkg.piezaNombre,
                                paquete_indice: pkg.paqueteNum, 
                                paquete_total: pkg.paquetesDePieza, 
                                piezas_en_paquete: pkg.cantidad,
                                tejedor: "Operario Móvil" // Nombre del tejedor por defecto para el móvil
                            };
                            break;
                        }
                    }
                }

                if (!foundPackage) {
                    setStatus({ type: 'error', message: `Código ${scannedCode} NO válido o no existe en órdenes activas.` });
                    return;
                }

                // Agregamos el objeto con todos los metadatos necesarios para el guardado
                setScans(prev => [...prev, foundPackage]);
                setStatus({ type: 'success', message: `¡Leído! Paquete ${foundPackage.paquete_indice} de ${foundPackage.modelo}` });
            };


            // 4. Confirmación y guardado
            const confirmScans = async () => {
                if (scans.length === 0 || isSaving) return;
                setIsSaving(true);
                setStatus({ type: 'info', message: `Guardando ${scans.length} registros...` });

                const successfulScans = [];
                const failedScans = [];

                for (const scan of scans) {
                    try {
                        // Verificar duplicados globales antes de guardar (seguridad)
                        const globalScanCheck = await db.collection('registro_produccion').where('codigo_paquete', '==', scan.code).get();
                        if (!globalScanCheck.empty) {
                            failedScans.push(`${scan.code} (Ya existe)`);
                            continue;
                        }

                        // Guardamos el registro con todos los metadatos obtenidos al escanear
                        await db.collection('registro_produccion').doc().set({
                            codigo_paquete: scan.code, 
                            orderId: String(scan.orderId), 
                            fecha: FieldValue.serverTimestamp(),
                            fecha_legible: new Date().toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace(/\//g, '/'), 
                            tejedor: scan.tejedor, 
                            tipo: "produccion",
                            modelo: scan.modelo,
                            partida: scan.partida,
                            paquete_indice: scan.paquete_indice, 
                            paquete_total: scan.paquete_total,
                            piezas_en_paquete: scan.piezas_en_paquete
                        });
                        
                        successfulScans.push(scan.code);

                    } catch (error) {
                        console.error("Error saving scan:", error);
                        failedScans.push(`${scan.code} (Error DB)`);
                    }
                }

                setIsSaving(false);
                setScans(prev => prev.filter(s => !successfulScans.includes(s.code))); // Eliminar los exitosos

                if (successfulScans.length > 0) {
                    setStatus({ type: 'success', message: `Guardados ${successfulScans.length}. Pendientes: ${scans.length - successfulScans.length}.` });
                } else if (failedScans.length > 0) {
                     setStatus({ type: 'error', message: `Fallo al guardar. Revisa los códigos.` });
                } else {
                    setStatus({ type: 'info', message: `Lista vacía.` });
                }
            };

            const removeScan = (codeToRemove) => {
                setScans(prev => prev.filter(s => s.code !== codeToRemove));
                setStatus({ type: 'info', message: `Código ${codeToRemove} eliminado de la lista.` });
            };
            
            const statusClass = status.type === 'info' ? 'bg-blue-600' : (status.type === 'success' ? 'bg-green-600' : (status.type === 'warning' ? 'bg-yellow-600' : 'bg-red-600'));


            return (
                <div className="flex flex-col h-screen max-h-screen">
                    <header className="p-3 bg-slate-900 shadow-lg flex justify-between items-center shrink-0">
                        <div className="flex items-center gap-2">
                            <Icon name="scan" size={24} className="text-yellow-400"/>
                            <h1 className="text-lg font-bold">Scanner Lite</h1>
                        </div>
                        <div className={`text-xs font-bold px-3 py-1 rounded-full ${statusClass} transition-all duration-300`}>{status.message.toUpperCase()}</div>
                    </header>
                    
                    <div className="camera-container shrink-0">
                        <div id="reader"></div>
                        <div className="scan-region">
                            <div className="scan-region-bottom-left"></div>
                            <div className="scan-region-bottom-right"></div>
                        </div>
                    </div>

                    <div className="flex flex-col flex-grow bg-slate-800">
                        <div className="p-3 border-b border-slate-700 flex justify-between items-center shrink-0">
                            <h2 className="text-sm font-bold text-slate-300">LISTA DE ESCANEOS PENDIENTES</h2>
                            <span className="text-xl font-black text-yellow-400">{scans.length}</span>
                        </div>
                        
                        <div className="flex-grow overflow-y-auto p-3 space-y-2">
                            {scans.length === 0 ? (
                                <div className="text-center text-slate-500 py-10 font-bold text-sm">Escanea tu primer código.</div>
                            ) : (
                                scans.map(scan => (
                                    <div key={scan.code} className="bg-slate-900 p-3 rounded-lg shadow-md flex justify-between items-center border-l-4 border-yellow-500">
                                        <div>
                                            <span className="font-mono font-bold text-lg text-white block">{scan.code}</span>
                                            <span className="text-xs text-slate-400">{scan.modelo} / PQT: {scan.paquete_indice}/{scan.paquete_total}</span>
                                        </div>
                                        <Icon 
                                            name="x" 
                                            size={24} 
                                            className="text-red-500 p-1 bg-slate-700 rounded-full cursor-pointer hover:bg-red-500 hover:text-white transition" 
                                            onClick={() => removeScan(scan.code)} 
                                        />
                                    </div>
                                ))
                            )}
                        </div>
                        
                        <div className="p-3 bg-slate-900 border-t border-slate-700 shrink-0">
                            <button 
                                onClick={confirmScans}
                                disabled={scans.length === 0 || isSaving}
                                className={`w-full py-3 rounded font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition-all\n                                    ${scans.length > 0 && !isSaving ? 'bg-green-600 text-white hover:bg-green-500 active:scale-[0.98]' : 'bg-slate-700 text-slate-500'}\n                                `}
                            >
                                {isSaving ? <><Icon name="loader-2" className="animate-spin"/> PROCESANDO...</> : <><Icon name="check-circle-2"/> CONFIRMAR ({scans.length})</>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ScannerG6 />);
    </script>
</body>
</html>