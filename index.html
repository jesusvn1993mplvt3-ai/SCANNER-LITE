<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balta Scan v18 - Intelligent Distributor</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; background: #020617; font-family: 'Roboto Condensed', sans-serif; color: white; overflow: hidden; }
        #reader { width: 100% !important; border: none !important; }
        #reader video { object-fit: cover !important; width: 100% !important; height: 250px !important; border-radius: 20px; }
        .scan-container { border: 4px solid #3b82f6; border-radius: 24px; overflow: hidden; background: #000; position: relative; }
        .overlay-wait { position: absolute; inset: 0; background: rgba(2, 6, 23, 0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 50; }
        
        .machine-selector { display: grid; grid-template-cols: repeat(4, 1fr); gap: 5px; margin-bottom: 10px; }
        .m-btn { padding: 10px 5px; background: #1e293b; border-radius: 8px; font-weight: 900; font-size: 14px; text-align: center; border: 2px solid transparent; }
        .m-btn.active { background: #3b82f6; border-color: white; color: white; }

        .label-mini { background: white; color: black; border-radius: 8px; padding: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 6px solid #fbbf24; }
        .scroll-area { max-height: 40vh; overflow-y: auto; padding-right: 5px; }
        .scroll-area::-webkit-scrollbar { width: 4px; }
        .scroll-area::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = { apiKey: "AIzaSyCngQL1pdqghv2vbjkPycT1Xf0C46f7jYs", authDomain: "cirineo-cec21.firebaseapp.com", projectId: "cirineo-cec21", storageBucket: "cirineo-cec21.firebasestorage.app", messagingSenderId: "620210618284", appId: "1:620210618284:web:482bab9bf74650fff18409" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const App = () => {
            const [active, setActive] = useState(false);
            const [pending, setPending] = useState(null);
            const [selectedMachine, setSelectedMachine] = useState(null);
            const [wait, setWait] = useState(0);
            const [machines, setMachines] = useState([]);
            const html5QrCode = useRef(null);

            useEffect(() => {
                // Generamos lista de máquinas 1-12 por defecto
                setMachines(Array.from({length: 12}, (_, i) => ({ id: `${i+1}`, name: `${i+1}` })));
            }, []);

            const startCamera = () => {
                const scanner = new Html5Qrcode("reader");
                html5QrCode.current = scanner;
                scanner.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, (text) => {
                    if (!pending && wait === 0) handleRead(text.trim().toUpperCase());
                }).catch(err => console.error(err));
            };

            const handleRead = async (code) => {
                if (!selectedMachine) {
                    alert("⚠️ SELECCIONA UNA MÁQUINA PRIMERO");
                    return;
                }

                if (code.startsWith('K')) {
                    const doc = await db.collection('kits_produccion').doc(code).get();
                    if (doc.exists) {
                        const data = doc.data();
                        setPending({ type: 'KIT', id: code, data: data, pieces: data.piezas });
                    } else alert("❌ Kit no encontrado en BD");
                } else {
                    // Buscar pieza individual en órdenes
                    const snap = await db.collection('orders').get();
                    let found = null;
                    snap.forEach(doc => {
                        const p = doc.data().progreso?.find(item => item.codigoUnico === code);
                        if(p) found = { ...p, orderId: doc.id, modelo: doc.data().codigo, partida: doc.data().partida };
                    });
                    if (found) setPending({ type: 'INDV', id: code, data: found, pieces: [found] });
                    else alert("❌ Código no reconocido");
                }
            };

            const confirmUpload = async () => {
                const batch = db.batch();
                const now = firebase.firestore.FieldValue.serverTimestamp();
                
                try {
                    pending.pieces.forEach(p => {
                        const ref = db.collection('registro_produccion').doc();
                        batch.set(ref, {
                            code: p.codigoUnico,
                            modelo: pending.data.modelo,
                            orderId: p.orderId,
                            partida: pending.data.partida,
                            paquete_indice: p.paqueteNum,
                            tejedor: "Sistema Balta",
                            fecha: now,
                            // ASIGNACIÓN CORRECTA DE MÁQUINA
                            maquina: selectedMachine.id, 
                            kitId: pending.type === 'KIT' ? pending.id : null,
                            finished: false
                        });
                    });
                    await batch.commit();
                    setPending(null);
                    setWait(3);
                    new Audio('https://www.soundjay.com/button/beep-07.mp3').play().catch(() => {});
                } catch (e) { alert("Error al guardar"); }
            };

            useEffect(() => {
                if (wait > 0) setTimeout(() => setWait(wait - 1), 1000);
            }, [wait]);

            return (
                <div className="p-4 h-screen bg-slate-950 flex flex-col">
                    {!active ? (
                        <div className="flex-1 flex flex-col items-center justify-center gap-6">
                            <h1 className="text-3xl font-black text-blue-500 italic">BALTA SCAN v18</h1>
                            <button onClick={() => { setActive(true); setTimeout(startCamera, 100); }} className="w-full bg-blue-600 py-10 rounded-3xl font-black text-2xl">INICIAR ESCÁNER</button>
                        </div>
                    ) : (
                        <div className="flex-1 flex flex-col min-h-0">
                            {/* Selector de Máquina */}
                            <div className="machine-selector">
                                {machines.map(m => (
                                    <button key={m.id} onClick={() => setSelectedMachine(m)} 
                                        className={`m-btn ${selectedMachine?.id === m.id ? 'active' : ''}`}>M{m.name}</button>
                                ))}
                            </div>

                            <div className={`scan-container ${pending ? 'h-32' : 'flex-1'}`}>
                                <div id="reader" style={{height: '100%'}}></div>
                                {wait > 0 && <div className="overlay-wait"><span className="text-6xl font-black">{wait}</span></div>}
                            </div>

                            {pending && (
                                <div className="mt-4 flex-1 bg-slate-100 rounded-t-3xl p-6 text-slate-900 flex flex-col overflow-hidden">
                                    <div className="flex justify-between items-center mb-4 border-b pb-2">
                                        <div>
                                            <p className="text-2xl font-black text-blue-800">{pending.id}</p>
                                            <p className="text-xs font-bold text-slate-500 uppercase">{pending.data.modelo} - PARTIDA {pending.data.partida}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-[10px] font-bold text-slate-400">DESTINO</p>
                                            <p className="text-xl font-black text-blue-600">MAQ {selectedMachine.name}</p>
                                        </div>
                                    </div>

                                    <div className="scroll-area flex-1">
                                        {pending.pieces.map((p, i) => (
                                            <div key={i} className="label-mini shadow-sm">
                                                <div>
                                                    <p className="font-black text-lg leading-none">{p.piezaNombre?.split(' ')[0]}</p>
                                                    <p className="text-[10px] font-bold text-slate-500">PAQ: {p.paqueteNum} | TALLA: {pending.data.talla}</p>
                                                </div>
                                                <p className="text-2xl font-black text-yellow-500">{p.cantidad}</p>
                                            </div>
                                        ))}
                                    </div>

                                    <div className="grid grid-cols-2 gap-4 mt-4">
                                        <button onClick={() => setPending(null)} className="bg-slate-300 py-4 rounded-2xl font-black text-slate-600">CANCELAR</button>
                                        <button onClick={confirmUpload} className="bg-blue-600 py-4 rounded-2xl font-black text-white text-xl shadow-lg">CONFIRMAR</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>