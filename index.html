<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Lite G6 - Cirineo</title>
    <meta name="description" content="Esc√°ner ligero de producci√≥n optimizado para dispositivos Moto G6 Play.">

    <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/d/d1/Barcode_Scanner_icon.png">
    <link rel="apple-touch-icon" href="https://upload.wikimedia.org/wikipedia/commons/d/d1/Barcode_Scanner_icon.png">
    
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://cirineo-cec21.web.app/"> <meta property="og:title" content="Esc√°ner de Producci√≥n Lite">
    <meta property="og:description" content="Herramienta ligera para escaneo de papeletas en planta. Optimizado para bajo consumo.">
    <meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/d/d1/Barcode_Scanner_icon.png">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:image" content="https://upload.wikimedia.org/wikipedia/commons/d/d1/Barcode_Scanner_icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #000; color: white; font-family: sans-serif; touch-action: manipulation; overscroll-behavior: none; }
        #root, .app-container { height: 100vh; height: 100dvh; display: flex; flex-direction: column; }
        #reader { width: 100%; flex-grow: 1; background: #000; position: relative; overflow: hidden; }
        #reader video { object-fit: cover; width: 100%; height: 100%; }
        .flash { animation: flashAnim 0.3s ease-out; }
        @keyframes flashAnim { 0% { background-color: rgba(255,255,255,0.8); } 100% { background-color: transparent; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue;

        const Icon = ({ name, size = 24, className, onClick }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && lucide.icons[name]) {
                    ref.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size, class: className });
                }
            }, [name, className]);
            return <span ref={ref} onClick={onClick} className={`inline-flex items-center justify-center ${onClick ? 'cursor-pointer' : ''}`}></span>;
        };

        const ScannerG6 = () => {
            const [scans, setScans] = useState([]);
            const [ordersCache, setOrdersCache] = useState([]);
            const [cameraActive, setCameraActive] = useState(false);
            const [statusMsg, setStatusMsg] = useState("Listo para iniciar");
            const [errorMsg, setErrorMsg] = useState("");
            const [isSaving, setIsSaving] = useState(false);
            const [installPrompt, setInstallPrompt] = useState(null); // NUEVO: Estado para el prompt de instalaci√≥n
            
            const scannerRef = useRef(null);

            // --- NUEVO: Escuchar evento de instalaci√≥n PWA ---
            useEffect(() => {
                const handler = (e) => {
                    // Prevenir que Chrome muestre el mini-infobar autom√°ticamente
                    e.preventDefault();
                    // Guardar el evento para activarlo luego con el bot√≥n
                    setInstallPrompt(e);
                    console.log("Evento de instalaci√≥n capturado");
                };
                window.addEventListener('beforeinstallprompt', handler);
                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);

            // --- NUEVO: Funci√≥n para disparar la instalaci√≥n ---
            const triggerInstall = async () => {
                if (!installPrompt) return;
                // Mostrar el di√°logo nativo de instalaci√≥n
                installPrompt.prompt();
                // Esperar a que el usuario decida
                const { outcome } = await installPrompt.userChoice;
                console.log(`User response to install prompt: ${outcome}`);
                // Resetear el prompt (ya no se puede usar de nuevo)
                setInstallPrompt(null);
            };

            // 1. Cargar datos
            useEffect(() => {
                setStatusMsg("Cargando base de datos...");
                const unsubscribe = db.collection('orders')
                    .where('status', '!=', 'ARCHIVADO')
                    .onSnapshot(snapshot => {
                        const loadedOrders = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                        setOrdersCache(loadedOrders);
                        setStatusMsg(`Base de datos lista: ${loadedOrders.length} √≥rdenes activas.`);
                    }, err => {
                        setErrorMsg("Error cargando datos: " + err.message);
                    });
                return () => unsubscribe();
            }, []);

            // 2. Iniciar C√°mara (Optimizada Moto G6)
            const startCamera = () => {
                setErrorMsg("");
                setStatusMsg("Iniciando c√°mara (Modo Lite)...");
                const config = { fps: 5, qrbox: { width: 250, height: 100 }, aspectRatio: 1.0 };
                const html5QrCode = new Html5Qrcode("reader");
                scannerRef.current = html5QrCode;
                html5QrCode.start(
                    { facingMode: "environment" }, 
                    config,
                    (decodedText) => handleScan(decodedText, html5QrCode),
                    () => {} // Ignorar errores de frame
                ).then(() => {
                    setCameraActive(true);
                    setStatusMsg("Escanea etiquetas de c√≥digo de barras.");
                }).catch(err => {
                    setCameraActive(false);
                    setErrorMsg("Error C√°mara: " + err + ". Aseg√∫rate de usar HTTPS.");
                });
            };

            const stopCamera = () => {
                if (scannerRef.current) {
                    scannerRef.current.stop().then(() => {
                        scannerRef.current.clear();
                        setCameraActive(false);
                        setStatusMsg("C√°mara detenida.");
                    }).catch(err => console.error(err));
                }
            };

            const handleScan = (codeRaw, scannerInstance) => {
                const code = codeRaw.trim().toUpperCase().replace(/'/g, '-').replace(/\?/g, '_');
                setScans(prev => {
                    if (prev.includes(code)) return prev;
                    playBeep();
                    document.getElementById('scan-flash').classList.add('flash');
                    setTimeout(() => document.getElementById('scan-flash').classList.remove('flash'), 300);
                    return [code, ...prev];
                });
                if(scannerInstance) {
                    scannerInstance.pause();
                    setTimeout(() => scannerInstance.resume(), 1200);
                }
            };

            const playBeep = () => {
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    osc.type = 'square'; osc.frequency.setValueAtTime(800, ctx.currentTime);
                    osc.connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime + 0.1);
                } catch(e) {}
            };

            const removeScan = (code) => {
                setScans(prev => prev.filter(c => c !== code));
            };

            const confirmScans = async () => {
                if (scans.length === 0 || isSaving) return;
                setIsSaving(true);
                stopCamera(); 
                let saved = 0, duplicates = 0, ignored = 0, ops = 0;
                const batch = db.batch();
                setStatusMsg("Procesando y guardando en nube...");

                const promises = scans.map(async (code) => {
                    const parts = code.split('-');
                    if (parts.length !== 3) { ignored++; return; }
                    const [model, partida, pkgIndexStr] = parts;
                    const order = ordersCache.find(o => String(o.codigo) === model && String(o.partida) === partida);
                    if (!order) { ignored++; return; }
                    const dupCheck = await db.collection('registro_produccion').where('codigo_paquete', '==', code).get();
                    if (!dupCheck.empty) { duplicates++; return; }

                    const docRef = db.collection('registro_produccion').doc();
                    const pkgIndex = parseInt(pkgIndexStr);
                    const pkgSize = parseInt(order.packageSize) || 50;
                    const totalPzs = order.totalPedido || 0;
                    const totalPkgs = Math.ceil(totalPzs / pkgSize);
                    const pzsInPkg = (pkgIndex < totalPkgs) ? pkgSize : (totalPzs % pkgSize || pkgSize);

                    batch.set(docRef, {
                        codigo_paquete: code, orderId: String(order.id), fecha: FieldValue.serverTimestamp(),
                        fecha_legible: new Date().toLocaleDateString('es-MX', {day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit'}),
                        tejedor: "Moto G6 Lite", tipo: "produccion", modelo: order.codigo, partida: order.partida,
                        paquete_indice: pkgIndex, piezas_en_paquete: pzsInPkg
                    });
                    ops++; saved++;
                });

                await Promise.all(promises);
                if (ops > 0) await batch.commit();
                setIsSaving(false); setScans([]);
                alert(`RESUMEN:\n‚úÖ Guardados: ${saved}\n‚ö†Ô∏è Repetidos: ${duplicates}\nüö´ Ignorados: ${ignored}`);
                setStatusMsg("Listo. Presiona 'Iniciar C√°mara' para seguir.");
            };

            return (
                <div className="app-container bg-slate-900 text-white relative">
                    <div id="scan-flash" className="absolute inset-0 pointer-events-none z-50"></div>

                    {/* HEADER MODIFICADO CON BOT√ìN DE INSTALAR */}
                    <div className="p-3 bg-slate-800 flex justify-between items-center shadow-md z-20">
                        <div className="flex items-center gap-3">
                            {/* NUEVO: Bot√≥n de instalaci√≥n (solo visible si el navegador lo permite) */}
                            {installPrompt && (
                                <button 
                                    onClick={triggerInstall} 
                                    className="bg-blue-600 p-2 rounded-full animate-pulse shadow-lg hover:bg-blue-500 flex items-center justify-center" 
                                    title="Instalar Aplicaci√≥n"
                                >
                                    <Icon name="download" size={20} className="text-white" />
                                </button>
                            )}
                            <div className="font-bold flex items-center gap-2">
                                <Icon name="scan-barcode" className="text-yellow-400" />
                                <span>MOTO G6 LITE</span>
                            </div>
                        </div>
                        <div className="text-xs text-slate-400 font-mono">{ordersCache.length} O.A.</div>
                    </div>

                    {(errorMsg || statusMsg) && (
                        <div className={`p-1 text-xs text-center font-mono truncate ${errorMsg ? 'bg-red-900 text-white' : 'bg-slate-700 text-slate-300'}`}>
                            {errorMsg || statusMsg}
                        </div>
                    )}

                    <div className="relative flex-grow bg-black overflow-hidden flex flex-col justify-center">
                        {!cameraActive && (
                            <div className="absolute inset-0 flex items-center justify-center z-10 bg-black/50">
                                <button onClick={startCamera} className="bg-blue-600/90 hover:bg-blue-500 text-white px-6 py-4 rounded-xl font-bold text-lg shadow-xl flex flex-col items-center gap-2 backdrop-blur-sm border border-blue-400/30">
                                    <Icon name="camera" size={36} />
                                    <span>INICIAR C√ÅMARA</span>
                                </button>
                            </div>
                        )}
                        <div id="reader"></div>
                    </div>

                    <div className="h-1/3 bg-slate-900 flex flex-col border-t border-slate-700 z-20">
                        <div className="bg-slate-800 p-2 text-xs font-bold flex justify-between uppercase tracking-wider text-slate-400">
                            <span>Buffer ({scans.length})</span>
                            {scans.length > 0 && <span onClick={() => setScans([])} className="text-red-400 cursor-pointer">Limpiar</span>}
                        </div>
                        <div className="flex-grow overflow-y-auto p-2 space-y-2">
                            {scans.length === 0 ? (
                                <div className="text-center text-slate-600 py-4 text-sm italic flex flex-col items-center">
                                    <Icon name="arrow-up-circle" size={24} className="mb-2 opacity-50"/>
                                    Lista vac√≠a. Inicia c√°mara.
                                </div>
                            ) : (
                                scans.map((code, i) => (
                                    <div key={i} className="flex justify-between items-center bg-slate-800 p-2 rounded border border-slate-700">
                                        <span className="font-mono font-bold text-lg text-yellow-500">{code}</span>
                                        <Icon name="x" size={24} className="text-red-500 p-1 bg-slate-900 rounded-full" onClick={() => removeScan(code)} />
                                    </div>
                                ))
                            )}
                        </div>
                        
                        <div className="p-3 bg-slate-800 border-t border-slate-700">
                            <button 
                                onClick={confirmScans}
                                disabled={scans.length === 0 || isSaving}
                                className={`w-full py-3 rounded font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition-all
                                    ${scans.length > 0 && !isSaving ? 'bg-green-600 text-white hover:bg-green-500Active:scale-95' : 'bg-slate-700 text-slate-500'}
                                `}
                            >
                                {isSaving ? <><Icon name="loader-2" className="animate-spin"/> PROCESANDO...</> : <><Icon name="check-circle-2"/> CONFIRMAR ({scans.length})</>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ScannerG6 />);
    </script>
</body>
</html>
