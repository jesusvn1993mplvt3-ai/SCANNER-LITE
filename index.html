<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balta Scan v17 (Conexión Agrupador)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; background: #020617; font-family: 'Roboto Condensed', sans-serif; color: white; overflow: hidden; }
        #reader { width: 100% !important; border: none !important; }
        #reader video { object-fit: cover !important; width: 100% !important; height: 300px !important; border-radius: 24px; }
        .machine-grid { display: grid; grid-template-cols: repeat(4, 1fr); gap: 6px; }
        .m-btn { background: #1e293b; padding: 12px 5px; border-radius: 12px; font-weight: 900; border: 2px solid transparent; transition: all 0.2s; }
        .m-btn.active { background: #3b82f6; border-color: white; transform: scale(0.95); }
        .label-mini { background: white; color: black; border-radius: 10px; padding: 10px; margin-bottom: 8px; border-left: 6px solid #3b82f6; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = { apiKey: "AIzaSyCngQL1pdqghv2vbjkPycT1Xf0C46f7jYs", authDomain: "cirineo-cec21.firebaseapp.com", projectId: "cirineo-cec21", storageBucket: "cirineo-cec21.firebasestorage.app", messagingSenderId: "620210618284", appId: "1:620210618284:web:482bab9bf74650fff18409" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const Icon = ({ name, size = 20 }) => {
            const ref = useRef(null);
            useEffect(() => { if (lucide.icons[name]) { ref.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size }); } }, [name, size]);
            return <span ref={ref} className="inline-block" />;
        };

        const App = () => {
            const [selectedMachine, setSelectedMachine] = useState(null);
            const [pending, setPending] = useState(null);
            const [allOrders, setAllOrders] = useState([]);
            const [machines, setMachines] = useState([]);
            const [scannerActive, setScannerActive] = useState(false);
            const html5QrCode = useRef(null);
            const lastScan = useRef(null);

            useEffect(() => {
                // Cargar máquinas (1-12 por defecto o desde BD)
                setMachines(Array.from({length: 12}, (_, i) => ({ id: `${i+1}`, name: `${i+1}` })));
                return db.collection('orders').onSnapshot(snap => {
                    setAllOrders(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
            }, []);

            const startScanner = () => {
                const scanner = new Html5Qrcode("reader");
                html5QrCode.current = scanner;
                scanner.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, 
                    (text) => handleScan(text.trim().toUpperCase())
                );
                setScannerActive(true);
            };

            const handleScan = async (code) => {
                if (lastScan.current === code || pending) return;
                lastScan.current = code;
                new Audio('https://www.soundjay.com/button/beep-07.mp3').play().catch(() => {});

                if (!selectedMachine) {
                    alert("⚠️ SELECCIONA UNA MÁQUINA");
                    lastScan.current = null;
                    return;
                }

                // SI ES UN KIT DEL AGRUPADOR
                if (code.startsWith('K')) {
                    const doc = await db.collection('kits_datos').doc(code).get();
                    if (doc.exists) {
                        const kit = doc.data();
                        setPending({
                            type: 'kit',
                            id: code,
                            data: kit,
                            piezas: kit.piezas.map(p => ({ ...p, modelo: kit.modelo, partida: kit.partida }))
                        });
                    } else alert("❌ Kit no encontrado");
                } 
                // SI ES PAPELETA INDIVIDUAL
                else {
                    let found = null;
                    allOrders.forEach(order => {
                        const p = order.progreso?.find(i => i.codigoUnico === code);
                        if (p) found = { ...p, orderId: order.id, modelo: order.codigo, partida: order.partida };
                    });

                    if (found) {
                        setPending({ type: 'single', id: code, data: found, piezas: [found] });
                    } else alert("❌ Código no reconocido");
                }
            };

            const confirmUpload = async () => {
                if (!pending || !selectedMachine) return;
                const batch = db.batch();
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();

                try {
                    pending.piezas.forEach(p => {
                        const ref = db.collection('production_scans').doc();
                        batch.set(ref, {
                            codigoUnico: p.codigoUnico || pending.id,
                            pedido: p.modelo || p.pedido || "",
                            estilo: p.modelo || "",
                            partida: p.partida || "",
                            paqueteNum: p.paqueteNum || 0,
                            piezaNombre: p.piezaNombre || "",
                            cantidad: p.cantidad || 0,
                            // ASIGNACIÓN A MÁQUINA
                            machineId: selectedMachine.id,
                            machineName: selectedMachine.name,
                            scannedAt: timestamp,
                            status: 'PENDIENTE'
                        });
                    });

                    await batch.commit();
                    setPending(null);
                    lastScan.current = null;
                    alert("✅ REGISTRADO EN MÁQUINA " + selectedMachine.name);
                } catch (e) { alert("Error al guardar"); }
            };

            return (
                <div className="flex flex-col h-screen p-4 max-w-md mx-auto">
                    {!scannerActive ? (
                        <div className="flex-1 flex flex-col items-center justify-center gap-8">
                            <h1 className="text-4xl font-black italic text-blue-500 tracking-tighter">BALTA SCAN v17</h1>
                            <button onClick={startScanner} className="w-full bg-blue-600 py-12 rounded-[40px] font-black text-2xl shadow-2xl shadow-blue-900/50">ABRIR CÁMARA</button>
                        </div>
                    ) : (
                        <div className="flex-1 flex flex-col min-h-0">
                            {/* Selector de Máquina */}
                            <div className="machine-grid mb-4">
                                {machines.map(m => (
                                    <button key={m.id} onClick={() => setSelectedMachine(m)} 
                                        className={`m-btn ${selectedMachine?.id === m.id ? 'active' : ''}`}>M{m.name}</button>
                                ))}
                            </div>

                            {/* Cámara / Preview */}
                            <div className={`relative bg-black rounded-[32px] overflow-hidden transition-all duration-300 ${pending ? 'h-32 opacity-50' : 'flex-1'}`}>
                                <div id="reader"></div>
                                {!selectedMachine && <div className="absolute inset-0 bg-black/80 flex items-center justify-center p-6 text-center font-bold text-yellow-500">⚠️ SELECCIONA MÁQUINA ANTES DE ESCANEAR</div>}
                            </div>

                            {/* Panel de Confirmación (Tu estética original) */}
                            {pending && (
                                <div className="mt-4 flex-1 bg-white rounded-t-[32px] p-6 text-slate-900 flex flex-col overflow-hidden animate-slide-up">
                                    <div className="flex justify-between items-start mb-4 border-b pb-2">
                                        <div>
                                            <p className="text-3xl font-black text-blue-900 leading-none">{pending.id}</p>
                                            <p className="text-sm font-bold text-slate-400 mt-1 uppercase">{pending.data.modelo} | PARTIDA {pending.data.partida}</p>
                                        </div>
                                        <div className="bg-blue-100 px-4 py-2 rounded-2xl text-center">
                                            <p className="text-[10px] font-bold text-blue-400 uppercase leading-none">MÁQUINA</p>
                                            <p className="text-2xl font-black text-blue-600">{selectedMachine.name}</p>
                                        </div>
                                    </div>

                                    <div className="flex-1 overflow-y-auto custom-scroll pr-2">
                                        {pending.piezas.map((p, i) => (
                                            <div key={i} className="label-mini flex justify-between items-center shadow-sm">
                                                <div>
                                                    <p className="font-black text-lg uppercase leading-none">{p.piezaNombre?.split(' ')[0]}</p>
                                                    <p className="text-[10px] font-bold text-slate-400 uppercase mt-1">Paquete #{p.paqueteNum}</p>
                                                </div>
                                                <div className="text-right">
                                                    <span className="text-3xl font-black text-blue-600 tracking-tighter">{p.cantidad}</span>
                                                    <span className="text-[10px] font-black block leading-none">PZAS</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                    <div className="grid grid-cols-2 gap-3 mt-4 pt-4 border-t">
                                        <button onClick={() => {setPending(null); lastScan.current = null;}} className="bg-slate-100 py-4 rounded-2xl font-black text-slate-400 uppercase text-sm">CANCELAR</button>
                                        <button onClick={confirmUpload} className="bg-blue-600 py-4 rounded-2xl font-black text-white text-xl uppercase tracking-tight shadow-xl shadow-blue-200">CONFIRMAR</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>