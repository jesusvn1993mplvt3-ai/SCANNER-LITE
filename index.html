<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner G6 - Cirineo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #000; color: white; font-family: sans-serif; touch-action: manipulation; }
        /* Forzar altura completa */
        #root, .app-container { height: 100vh; display: flex; flex-direction: column; }
        
        /* Ajustes de Video para Moto G6 */
        #reader { width: 100%; flex-grow: 1; background: #000; position: relative; overflow: hidden; }
        #reader video { object-fit: cover; width: 100%; height: 100%; }
        
        /* Animaci√≥n de escaneo exitoso */
        .flash { animation: flashAnim 0.3s ease-out; }
        @keyframes flashAnim { 0% { background-color: rgba(255,255,255,0.8); } 100% { background-color: transparent; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue;

        // --- ICONO ---
        const Icon = ({ name, size = 24, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && lucide.icons[name]) {
                    ref.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size, class: className });
                }
            }, [name, className]);
            return <span ref={ref} className="inline-flex items-center justify-center"></span>;
        };

        // --- APP ---
        const ScannerG6 = () => {
            const [scans, setScans] = useState([]);
            const [ordersCache, setOrdersCache] = useState([]);
            const [cameraActive, setCameraActive] = useState(false);
            const [statusMsg, setStatusMsg] = useState("Listo para iniciar");
            const [errorMsg, setErrorMsg] = useState("");
            const [isSaving, setIsSaving] = useState(false);
            
            const scannerRef = useRef(null); // Instancia del esc√°ner HTML5
            const beepRef = useRef(null); // Audio

            // 1. Cargar datos (Solo una vez)
            useEffect(() => {
                setStatusMsg("Cargando base de datos...");
                const unsubscribe = db.collection('orders')
                    .where('status', '!=', 'ARCHIVADO')
                    .onSnapshot(snapshot => {
                        const loadedOrders = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                        setOrdersCache(loadedOrders);
                        setStatusMsg(`Base de datos lista: ${loadedOrders.length} √≥rdenes.`);
                    }, err => {
                        setErrorMsg("Error cargando datos: " + err.message);
                    });
                return () => unsubscribe();
            }, []);

            // 2. Funci√≥n para INICIAR C√ÅMARA (Manual para evitar bloqueos)
            const startCamera = () => {
                setErrorMsg("");
                setStatusMsg("Iniciando c√°mara...");

                // Configuraci√≥n espec√≠fica para rendimiento en gama baja
                const config = {
                    fps: 5, // Bajamos FPS para no calentar el cel
                    qrbox: { width: 250, height: 100 }, // Caja m√°s ancha para c√≥digo de barras
                    aspectRatio: 1.0
                };

                // IMPORTANTE: Limitamos SOLO a CODE_128 (Barras normales) para velocidad extrema
                const formats = { formatsToSupport: [ Html5QrcodeSupportedFormats.CODE_128 ] };

                const html5QrCode = new Html5Qrcode("reader");
                scannerRef.current = html5QrCode;

                html5QrCode.start(
                    { facingMode: "environment" }, 
                    config,
                    (decodedText) => {
                        handleScan(decodedText, html5QrCode);
                    },
                    (errorMessage) => {
                        // Ignoramos errores de cuadro por cuadro para no saturar
                    }
                ).then(() => {
                    setCameraActive(true);
                    setStatusMsg("C√°mara activa. Escanea etiquetas.");
                }).catch(err => {
                    setCameraActive(false);
                    setErrorMsg("Error de C√°mara: " + err);
                    if(window.location.protocol === 'file:') {
                        alert("ERROR CR√çTICO: No puedes usar la c√°mara abriendo el archivo directo. Debes subirlo a un servidor (Firebase/Github) o usar localhost.");
                    }
                });
            };

            const stopCamera = () => {
                if (scannerRef.current) {
                    scannerRef.current.stop().then(() => {
                        scannerRef.current.clear();
                        setCameraActive(false);
                        setStatusMsg("C√°mara detenida.");
                    }).catch(err => console.error(err));
                }
            };

            const handleScan = (codeRaw, scannerInstance) => {
                const code = codeRaw.trim().toUpperCase().replace(/'/g, '-').replace(/\?/g, '_');
                
                // Evitar re-escaneo inmediato del mismo c√≥digo
                setScans(prev => {
                    if (prev.includes(code)) return prev;
                    
                    // Efecto visual y sonoro
                    playBeep();
                    document.getElementById('scan-flash').classList.add('flash');
                    setTimeout(() => document.getElementById('scan-flash').classList.remove('flash'), 300);

                    return [code, ...prev];
                });
                
                // Pausar brevemente para dar feedback visual
                if(scannerInstance) {
                    scannerInstance.pause();
                    setTimeout(() => scannerInstance.resume(), 1200);
                }
            };

            const playBeep = () => {
                // Beep sint√©tico simple sin cargar archivos externos
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, ctx.currentTime);
                osc.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.1);
            };

            const removeScan = (code) => {
                setScans(prev => prev.filter(c => c !== code));
            };

            const confirmScans = async () => {
                if (scans.length === 0 || isSaving) return;
                setIsSaving(true);
                stopCamera(); // Detener c√°mara para liberar memoria mientras guarda

                let saved = 0, duplicates = 0, ignored = 0;
                const batch = db.batch();
                let ops = 0;

                setStatusMsg("Verificando y guardando...");

                const promises = scans.map(async (code) => {
                    const parts = code.split('-');
                    if (parts.length !== 3) { ignored++; return; }
                    
                    const [model, partida, pkgIndexStr] = parts;
                    
                    // Buscar en cache (r√°pido)
                    const order = ordersCache.find(o => String(o.codigo) === model && String(o.partida) === partida);
                    if (!order) { ignored++; return; }

                    // Checar duplicado en nube (lento pero seguro)
                    const dupCheck = await db.collection('registro_produccion').where('codigo_paquete', '==', code).get();
                    if (!dupCheck.empty) { duplicates++; return; }

                    const docRef = db.collection('registro_produccion').doc();
                    const pkgIndex = parseInt(pkgIndexStr);
                    const pkgSize = parseInt(order.packageSize) || 50;
                    const totalPzs = order.totalPedido || 0;
                    const totalPkgs = Math.ceil(totalPzs / pkgSize);
                    const pzsInPkg = (pkgIndex < totalPkgs) ? pkgSize : (totalPzs % pkgSize || pkgSize);

                    batch.set(docRef, {
                        codigo_paquete: code,
                        orderId: String(order.id),
                        fecha: FieldValue.serverTimestamp(),
                        fecha_legible: new Date().toLocaleDateString('es-MX'),
                        tejedor: "Moto G6",
                        tipo: "produccion",
                        modelo: order.codigo,
                        partida: order.partida,
                        paquete_indice: pkgIndex,
                        piezas_en_paquete: pzsInPkg
                    });
                    ops++;
                    saved++;
                });

                await Promise.all(promises);
                if (ops > 0) await batch.commit();

                setIsSaving(false);
                setScans([]);
                alert(`RESUMEN:\n‚úÖ Guardados: ${saved}\n‚ö†Ô∏è Repetidos: ${duplicates}\nüö´ Ignorados: ${ignored}`);
                setStatusMsg("Listo. Presiona 'Iniciar C√°mara' para seguir.");
            };

            return (
                <div className="app-container bg-slate-900 text-white relative">
                    {/* Capa de Flash Visual */}
                    <div id="scan-flash" className="absolute inset-0 pointer-events-none z-50"></div>

                    {/* HEADER */}
                    <div className="p-3 bg-slate-800 flex justify-between items-center shadow-md z-20">
                        <div className="font-bold flex items-center gap-2">
                            <Icon name="scan-barcode" className="text-yellow-400" />
                            <span>MOTO G6 LITE</span>
                        </div>
                        <div className="text-xs text-slate-400">{ordersCache.length} O.A.</div>
                    </div>

                    {/* ZONA DE ERROR / STATUS */}
                    {(errorMsg || statusMsg) && (
                        <div className={`p-2 text-xs text-center font-mono ${errorMsg ? 'bg-red-900 text-white' : 'bg-slate-700 text-slate-300'}`}>
                            {errorMsg || statusMsg}
                        </div>
                    )}

                    {/* VISOR DE C√ÅMARA */}
                    <div className="relative flex-grow bg-black overflow-hidden flex flex-col justify-center">
                        {!cameraActive && (
                            <div className="absolute inset-0 flex items-center justify-center z-10">
                                <button onClick={startCamera} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-4 rounded-full font-bold text-lg shadow-lg flex flex-col items-center gap-2 animate-bounce">
                                    <Icon name="camera" size={32} />
                                    <span>INICIAR C√ÅMARA</span>
                                </button>
                            </div>
                        )}
                        <div id="reader"></div>
                    </div>

                    {/* LISTA DE ESCANEOS (BUFFER) */}
                    <div className="h-1/3 bg-slate-900 flex flex-col border-t border-slate-700 z-20">
                        <div className="bg-slate-800 p-2 text-xs font-bold flex justify-between uppercase tracking-wider text-slate-400">
                            <span>Pendientes ({scans.length})</span>
                            <span onClick={() => setScans([])} className="text-red-400 cursor-pointer">Borrar Todo</span>
                        </div>
                        <div className="flex-grow overflow-y-auto p-2 space-y-2">
                            {scans.length === 0 ? (
                                <div className="text-center text-slate-600 py-4 text-sm italic">
                                    Presiona INICIAR C√ÅMARA<br/>y escanea los c√≥digos de barras.
                                </div>
                            ) : (
                                scans.map((code, i) => (
                                    <div key={i} className="flex justify-between items-center bg-slate-800 p-2 rounded border border-slate-700">
                                        <span className="font-mono font-bold text-lg text-yellow-500">{code}</span>
                                        <button onClick={() => removeScan(code)} className="p-2 text-red-500 bg-slate-900 rounded-full">
                                            <Icon name="x" size={18} />
                                        </button>
                                    </div>
                                ))
                            )}
                        </div>
                        
                        {/* BOT√ìN CONFIRMAR */}
                        <div className="p-3 bg-slate-800 border-t border-slate-700">
                            <button 
                                onClick={confirmScans}
                                disabled={scans.length === 0 || isSaving}
                                className={`w-full py-3 rounded font-bold text-lg shadow-lg flex items-center justify-center gap-2
                                    ${scans.length > 0 && !isSaving ? 'bg-green-600 text-white hover:bg-green-500' : 'bg-slate-700 text-slate-500'}
                                `}
                            >
                                {isSaving ? "PROCESANDO..." : `CONFIRMAR (${scans.length})`}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ScannerG6 />);
    </script>
</body>
</html>
