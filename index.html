<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Lite G6 - Cirineo</title>
    <meta name="description" content="Escáner ligero de producción optimizado para dispositivos Moto G6 Play.">

    <link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/d/d1/Barcode_Scanner_icon.png">
    <link rel="apple-touch-icon" href="https://upload.wikimedia.org/wikipedia/commons/d/d1/Barcode_Scanner_icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #000; color: white; font-family: sans-serif; touch-action: manipulation; overscroll-behavior: none; }
        #root, .app-container { height: 100vh; height: 100dvh; display: flex; flex-direction: column; }
        .flash { animation: flashAnim 0.3s ease-out; }
        @keyframes flashAnim { 0% { background-color: rgba(255,255,255,0.8); } 100% { background-color: transparent; } }
        
        /* Estilos para el modal del escáner - MODIFICACIÓN AQUÍ */
        .camera-container-modal { 
            width: 100%; 
            /* Reducimos la altura máxima de 50vh a 35vh para dejar más espacio al buffer */
            max-height: 35vh; 
            overflow: hidden; 
            position: relative; 
            background: black; 
            flex-shrink: 0; /* Asegura que no se haga más pequeña que su contenido mínimo */
        }
        #reader-modal { width: 100%; height: 100%; }
        #reader-modal a { display: none !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBqHgV4vDat1-VmZfKbiPg7nuiX-ROcexw",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409",
            measurementId: "G-B7YLM78RVW"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue;

        const Icon = ({ name, size = 24, className, onClick }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && lucide.icons[name]) {
                    ref.current.innerHTML = lucide.icons[name].toSvg({ width: size, height: size, class: className });
                }
            }, [name, className]);
            return <span ref={ref} onClick={onClick} className={`inline-flex items-center justify-center ${onClick ? 'cursor-pointer' : ''}`}></span>;
        };

        const playBeep = () => {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                osc.type = 'square'; osc.frequency.setValueAtTime(800, ctx.currentTime);
                osc.connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime + 0.1);
            } catch(e) {}
        };

        // --- COMPONENTE MODAL DEL ESCÁNER ---
        const QuickScannerModal = ({ isVisible, onClose, ordersCache, onScanSaved }) => {
            const [scans, setScans] = useState([]); // Buffer local de paquetes encontrados
            const [scanStatus, setScanStatus] = useState({ message: 'Iniciando cámara...', type: 'info' });
            const [isSaving, setIsSaving] = useState(false);
            const scannerRef = useRef(null);
            const SCAN_INTERVAL_MS = 1500; // Pausa después de cada escaneo

            // 1. Manejo de la cámara al abrir/cerrar
            useEffect(() => {
                if (isVisible) {
                    setScans([]); // Limpiar buffer al iniciar un nuevo escaneo
                    setScanStatus({ message: 'Iniciando cámara...', type: 'info' });
                    
                    // Inicializar scanner después de un pequeño retraso
                    setTimeout(() => {
                        const html5QrcodeScanner = new Html5QrcodeScanner(
                            "reader-modal", 
                            { 
                                fps: 5, // Baja FPS
                                qrbox: { width: 220, height: 180 }, // Reducimos área
                                aspectRatio: 1.0, 
                                videoConstraints: { facingMode: "environment" } 
                            },
                            false
                        );

                        const onScanSuccess = (decodedText) => {
                            handleQuickScan(decodedText);
                            if (scannerRef.current) {
                                scannerRef.current.pause(); 
                                setTimeout(() => scannerRef.current.resume(), SCAN_INTERVAL_MS); 
                            }
                        };

                        html5QrcodeScanner.render(onScanSuccess, (errorMessage) => {
                            if (scanStatus.message === 'Iniciando cámara...') {
                                setScanStatus({ type: 'info', message: 'Cámara lista. Escanea.' });
                            }
                        });
                        scannerRef.current = html5QrcodeScanner;
                    }, 100);
                } else {
                    // Limpiar scanner al cerrar
                    if (scannerRef.current) {
                        scannerRef.current.clear().catch(err => console.error("Error clearing scanner on close", err));
                        scannerRef.current = null;
                    }
                }
                return () => { if (scannerRef.current) scannerRef.current.clear().catch(err => {}); };
            }, [isVisible]);


            // 2. LÓGICA DE ESCANEO INTELIGENTE (Busca el Código Único)
            const handleQuickScan = (rawCode) => {
                if (!rawCode) return;
                const scannedCode = rawCode.trim().toUpperCase().replace(/'/g, '-').replace(/\?/g, '_');

                if (scans.some(s => s.code === scannedCode)) {
                    setScanStatus({ message: `Código ${scannedCode} ya en la lista.`, type: 'warning' });
                    return;
                }

                // Buscar el código único en todas las órdenes activas
                let foundPackage = null;
                for (const order of ordersCache) {
                    if (order.progreso) {
                        const pkg = order.progreso.find(p => p.codigoUnico === scannedCode);
                        if (pkg) {
                            foundPackage = { 
                                code: scannedCode, 
                                orderId: order.id, 
                                modelo: order.codigo, 
                                partida: order.partida,
                                piezaNombre: pkg.piezaNombre,
                                paquete_indice: pkg.paqueteNum, 
                                paquete_total: pkg.paquetesDePieza, 
                                piezas_en_paquete: pkg.cantidad,
                                tejedor: "Moto G6 Lite" 
                            };
                            break;
                        }
                    }
                }

                if (!foundPackage) {
                    setScanStatus({ message: `Código ${scannedCode} NO encontrado en órdenes.`, type: 'error' });
                    return;
                }
                
                playBeep();
                setScans(prev => [...prev, foundPackage]);
                setScanStatus({ type: 'success', message: `¡Leído! Paquete ${foundPackage.paquete_indice} de ${foundPackage.modelo}` });
            };

            // 3. Guardar todos los escaneos
            const confirmScans = async () => {
                if (scans.length === 0 || isSaving) return;
                setIsSaving(true);
                setScanStatus({ message: `Guardando ${scans.length} registros...`, type: 'info' });

                let saved = 0, duplicates = 0, errors = 0;
                const batch = db.batch();
                
                for (const scan of scans) {
                    try {
                        const globalScanCheck = await db.collection('registro_produccion').where('codigo_paquete', '==', scan.code).get();
                        if (!globalScanCheck.empty) { 
                            duplicates++; 
                            continue; 
                        }

                        const docRef = db.collection('registro_produccion').doc();
                        batch.set(docRef, {
                            codigo_paquete: scan.code, 
                            orderId: String(scan.orderId), 
                            fecha: FieldValue.serverTimestamp(),
                            fecha_legible: new Date().toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace(/\//g, '/'), 
                            tejedor: scan.tejedor, 
                            tipo: "produccion",
                            modelo: scan.modelo,
                            partida: scan.partida,
                            paquete_indice: scan.paquete_indice, 
                            paquete_total: scan.paquete_total,
                            piezas_en_paquete: scan.piezas_en_paquete
                        });
                        saved++;

                    } catch (error) {
                        console.error("Error saving scan:", error);
                        errors++;
                    }
                }

                if (saved > 0) await batch.commit();

                setIsSaving(false);
                onScanSaved(saved); // Informar al componente principal
                onClose();
                alert(`Guardado finalizado:\n✅ Guardados: ${saved}\n⚠️ Repetidos: ${duplicates}\n❌ Errores: ${errors}`);
            };

            const handleRemoveScan = (codeToRemove) => setScans(prev => prev.filter(scan => scan.code !== codeToRemove));

            if (!isVisible) return null;

            const statusClass = scanStatus.type === 'info' ? 'bg-blue-600' : (scanStatus.type === 'success' ? 'bg-green-600' : (scanStatus.type === 'warning' ? 'bg-yellow-600' : 'bg-red-600'));

            return (
                <div className="fixed inset-0 bg-black z-50 flex flex-col">
                    <div className="p-3 bg-slate-800 flex justify-between items-center shadow-md shrink-0">
                        <h2 className="text-lg font-bold flex items-center gap-2"><Icon name="scan-line" className="text-yellow-400"/> ESCANEAR PAQUETES</h2>
                        <button onClick={onClose} className="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded text-sm font-bold flex items-center gap-1"><Icon name="x" size={16}/> CERRAR</button>
                    </div>

                    {/* La altura de este contenedor fue ajustada en el CSS a max-height: 35vh */}
                    <div className="camera-container-modal shrink-0">
                        <div id="reader-modal"></div>
                        {/* Indicador de estado */}
                        <div className={`absolute bottom-0 w-full text-center py-1 text-xs font-bold ${statusClass}`}>{scanStatus.message}</div>
                    </div>
                    
                    <div className="flex flex-col flex-grow bg-slate-900">
                        {/* Encabezado del buffer */}
                        <div className="p-2 text-xs font-bold flex justify-between uppercase tracking-wider text-slate-400 border-b border-slate-700 shrink-0">
                            <span>Paquetes en Buffer</span>
                            <span className="text-white">{scans.length}</span>
                        </div>
                        
                        {/* LISTA DE PAQUETES: Este div tiene 'flex-grow' y 'overflow-y-auto' para que sea el único que se desplace */}
                        <div className="flex-grow overflow-y-auto p-3 space-y-2">
                            {scans.length === 0 ? (
                                <div className="text-center text-slate-600 py-4 text-sm italic">Escanea un código para empezar.</div>
                            ) : (
                                scans.map(scan => (
                                    <div key={scan.code} className="flex justify-between items-center bg-slate-800 p-2 rounded border border-slate-700 border-l-4 border-yellow-500">
                                        <div>
                                            <span className="font-mono font-bold text-base text-white block">{scan.code}</span>
                                            <span className="text-xs text-slate-400">{scan.modelo} / PQT: {scan.paquete_indice}/{scan.paquete_total}</span>
                                        </div>
                                        <button onClick={() => handleRemoveScan(scan.code)} className="text-red-500 p-1 bg-slate-700 rounded-full flex items-center justify-center"><Icon name="trash-2" size={16}/></button>
                                    </div>
                                ))
                            )}
                        </div>
                        
                        {/* PIE DE PÁGINA: Este div tiene 'shrink-0' para que permanezca FIJO y no se mueva */}
                        <div className="p-3 bg-slate-800 border-t border-slate-700 shrink-0">
                            <button 
                                onClick={confirmScans}
                                disabled={scans.length === 0 || isSaving}
                                className={`w-full py-3 rounded font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition-all
                                    ${scans.length > 0 && !isSaving ? 'bg-green-600 text-white hover:bg-green-500' : 'bg-slate-700 text-slate-500'}
                                `}
                            >
                                {isSaving ? <><Icon name="loader-2" className="animate-spin"/> PROCESANDO...</> : <><Icon name="check-circle-2"/> ACEPTAR Y REGISTRAR ({scans.length})</>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };


        // --- COMPONENTE PRINCIPAL ---
        const ScannerG6 = () => {
            const [ordersCache, setOrdersCache] = useState([]);
            const [statusMsg, setStatusMsg] = useState("Cargando base de datos...");
            const [errorMsg, setErrorMsg] = useState("");
            const [showScanner, setShowScanner] = useState(false);
            const [lastSaveCount, setLastSaveCount] = useState(0);

            // Cargar datos
            useEffect(() => {
                const unsubscribe = db.collection('orders')
                    .where('status', '!=', 'ARCHIVADO')
                    .onSnapshot(snapshot => {
                        const loadedOrders = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                        setOrdersCache(loadedOrders);
                        setStatusMsg(`Base de datos lista: ${loadedOrders.length} órdenes activas.`);
                    }, err => {
                        setErrorMsg("Error cargando datos: " + err.message);
                    });
                return () => unsubscribe();
            }, []);

            return (
                <div className="app-container bg-slate-900 text-white relative">

                    {/* HEADER */}
                    <div className="p-3 bg-slate-800 flex justify-between items-center shadow-md z-20 shrink-0">
                        <div className="font-bold flex items-center gap-2">
                            <Icon name="scan-barcode" className="text-yellow-400" />
                            <span>MOTO G6 LITE</span>
                        </div>
                        <div className="text-xs text-slate-400 font-mono">{ordersCache.length} O.A.</div>
                    </div>

                    {/* STATUS BAR */}
                    {(errorMsg || statusMsg) && (
                        <div className={`p-1 text-xs text-center font-mono truncate ${errorMsg ? 'bg-red-900 text-white' : 'bg-slate-700 text-slate-300'} shrink-0`}>
                            {errorMsg || statusMsg}
                        </div>
                    )}

                    {/* MAIN CONTENT / BUTTON */}
                    <div className="flex-grow flex flex-col items-center justify-center p-4">
                        <button 
                            onClick={() => setShowScanner(true)} 
                            className="bg-green-600/90 hover:bg-green-500 text-white px-8 py-6 rounded-xl font-bold text-2xl shadow-xl flex flex-col items-center gap-4 transition transform active:scale-95"
                        >
                            <Icon name="camera" size={48} />
                            <span>INICIAR ESCANEO</span>
                        </button>
                        {lastSaveCount > 0 && (
                            <div className="mt-6 bg-blue-600 text-white p-3 rounded-lg text-sm font-bold animate-pulse">
                                ✅ Último guardado: {lastSaveCount} paquetes.
                            </div>
                        )}
                        <div className="mt-8 text-center text-slate-500 text-sm">
                            <Icon name="archive" size={16} className="inline-block mr-1"/>
                            Órdenes activas: {ordersCache.length}
                        </div>
                    </div>
                    
                    {/* MODAL DEL ESCANER */}
                    <QuickScannerModal
                        isVisible={showScanner}
                        onClose={() => setShowScanner(false)}
                        ordersCache={ordersCache}
                        onScanSaved={setLastSaveCount} // Para mostrar el resumen en la pantalla principal
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ScannerG6 />);
    </script>
</body>
</html>
